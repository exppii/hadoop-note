集群时钟同步配置（NTP）
----
目标环境，N台Linux CentOS6.5，一台作为NTP服务与外部NTP服务同步时间，同时，内网其他机器与这台
机器做时间同步。

|IP地址         |       角色      |       说明        |
|:------:      |       :---:     |         :---:    |
|192.168.21.200|    NTP 服务端   |  负责与外部服务器同步;<br> 为内外提供NTP服务 |
|192.168.21.XX |  内网NTP客户端   | 与192.168.21.200同步  |
| ******     |   内网NTP客户端      | 与192.168.21.200同步    |


### 下载安装同步服务
```bash
[root@client ~]# yum install ntp
```
在开启NTP服务前，先使用`ntpdate`命令直接同步（非平滑同步方式)，免得与外部时间相差太大
，让NTP不能正常同步:
```bash
[root@client ~]# ntpdate cn.pool.ntp.org
```
### NTP Server端（192.168.21.211）配置
配置文件：**/etc/ntp.conf**
```vim
# For more information about this file, see the man pages
# ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).

driftfile /var/lib/ntp/drift

# 允许内网其他机器同步此机器
restrict 192.168.21.0 mask 255.255.255.0 nomodify notrap

# Use public servers from the pool.ntp.org project.
# Please consider joining the pool (http://www.pool.ntp.org/join.html).
#设置与中国相关服务器
server 210.72.145.44 perfer
server 1.cn.pool.ntp.org
server 0.asia.pool.ntp.org

#允许上层时间服务器 主动修改本机时间
restrict 1.cn.pool.ntp.org nomodify notrap noquery
restrict 0.asia.pool.ntp.org nomodify notrap noquery

#外部时间不可用时，以本地时间作为时间服务
server 127.127.1.0
fudge 127.127.1.0 stratum 10

includefile /etc/ntp/crypto/pw

# Key file containing the keys and key identifiers used when operating
# with symmetric key cryptography.
keys /etc/ntp/keys
# Specify the key identifiers which are trusted.
```
配置文件修改完成后保存退出，启动服务：
```bash
[root@client ~]# service ntpd start
```
启动后，一般需要5-10分钟才能与外部时间服务器同步时间。查看服务连接和监听：
```bash
[root@client ~]# netstat -tlunp | grep ntp
udp        0      0 192.168.21.200:123          0.0.0.0:*                               1130/ntpd
udp        0      0 127.0.0.1:123               0.0.0.0:*                               1130/ntpd
udp        0      0 0.0.0.0:123                 0.0.0.0:*                               1130/ntpd
udp        0      0 fe80::862b:2bff:fec0:fa5:123 :::*                                    1130/ntpd
udp        0      0 ::1:123                     :::*                                    1130/ntpd
udp        0      0 :::123                      :::*                                    1130/ntpd
[root@client ~]#

```

添加开机启动：
```bash
[root@client ~]# chkconfig ntpd on
[root@client ~]# chkconfig --list ntpd
ntpd           	0:关闭	1:关闭	2:启用	3:启用	4:启用	5:启用	6:关闭
```
